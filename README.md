# Charge Smoothing
This is the charge smoothing branch of the Bader Integration repository. Although it is not directly related to Bader integration or the weight method, it was developed from some of the code pieces in this repository, especially the CHGCAR manipulation routines in directory ```chgcar-manipulation``` written by Prof. Trinkle.

Here, charge smoothing refers to suppressing the high-frequency components of a charge density in the reciprocal space. Because these high-frequency components could lead to numerical noise in the real space, such operation is possible to make the charge density a smoother quantity. In this code, the smoothing procedure is decribed as

$$\rho(\mathbf{r}) \xrightarrow{\text{FFT}} \rho(\mathbf{G}) \xrightarrow{\text{smoothing}} \rho'(\mathbf{G}) \xrightarrow{\text{IFFT}} \rho'(\mathbf{r}) $$

where we take the original charge density $\rho(\mathbf{r})$, do a fast Fourier transform (FFT), apply the smoothing method or a low-pass filter, and get the smoothed charge density $\rho'(\mathbf{r})$ after an inverse fast fourier transform (IFFT).

Two smoothing methods or low-pass filters are implemented in file ```smooth.H```: a power-law truncation filter and a Gaussian filter. The code extracts the parameters of the chosen filter by fitting a power-law/Gaussian curve to a reference (expected to be smooth and well-behaved) charge density, and then apply the filter to the target charge density to smooth it. See functions ```extract_filter()``` and ```apply_filter()```, or ```extract_filter_gaussian()``` and ```apply_filter_gaussian()``` in file ```smooth.H``` for more details.

Two parameters are currently hard-coded in this code: an integer ```GAUSSIAN``` which controls whether the Gaussian filter or the power-law truncation filter is to be used, and a double-type ```FILTER_MULT``` which manually scales the parameter ```l0``` of the Gaussian filter. (Yang found in his own research that the extracted Gaussian filter was not the optimal one, so he made manual adjustments and chose to determine the parameter with other methods.) 

Please read the source code in ```chgcar_smoothing.C``` and ```smoothing.H```, understand what it is doing before reusing it.

The charge smoothing source code is put in directory ```chgcar-smoothing```. To compile the code, run command

    make

A cpp compiler such as g++ is required for compilation. This code uses the GNU Scientific Library (gsl library). In Ubuntu, this library can be acquired by running ```sudo apt-get install libgsl-dev```.

To run the compiled binary ```chgcar_smoothing```, run command

    ./chgcar_smoothing CHGCAR_ref CHGCAR_tgt > CHGCAR_smoothed

where ```CHGCAR_ref``` is the reference charge density for filter extraction, ```CHGCAR_tgt``` is the target charge density to be smoothed, and ```CHGCAR_smoothed``` is the smoothed charge density. It is assumed that the charge density files are in the CHGCAR-format of VASP 4. For files generated by VASP 5 or newer versions, please remove the line in the CHGCAR file header that specifies the ion species; alternatively, consider updating the code (one can replace the ```chgcar.H``` file here with the updated ```chgcar.H``` file in the master branch, and add a line in file ```chgcar_smoothing.C``` to output the ion species).

This code was developed by Yang Dan, and used in the publication below. Details about charge smoothing are provided in the supplementary material.

* Y. Dan and D. R. Trinkle, "First-principles core energies of isolated basal and prism screw dislocations in magnesium." *Mater. Res. Lett.* **10**, 360â€“368 (2022). [doi](https://doi.org/10.1080/21663831.2022.2051763)

***

Below is the original README.

***

# Bader integration using weighted integration
This code takes the grid-based output from [VASP](https://www.vasp.at/) as from CHGCAR or AECCAR files and performs *Bader integration* over the basins of attraction. The call

    weight_int CHGCAR [grid1] [grid2] ...

uses the first grid to define atom-centered basins of attraction, and integrates each grid-defined quantity over those same basins of attraction. At a minimum, one grid file can be used. The grids must all be *compatible*: same grid dimensions defined for each. It does not check that the atomic coordinates are the same, and it *only* reads in the first grid found in the file; thus, it requires some hacking of the files in order to, e.g., integrate the magnetization. There are a few options available:

* **-a** assigns volumes to true basins (maxima) rather than explicitly to atoms.
* **-s** divides (scales) the integral by the total volume of the cell; required to compute a Bader charge.
* **-o base** output the weights on a grid, to be used for visualization; "base" is the name of the weight file: base0001
* **-n N** output only the weight for atom/basin N
* **-V** use Voronoi volumes instead of Bader (basins of attraction)
* **-v/-t** verbose or testing (extra verbose) modes

# References
Original algorithm described in the first reference; the latter two references include examples. *If you use the code, please cite the first reference* as well as [![DOI](https://zenodo.org/badge/doi/10.5281/zenodo.18776.svg)](http://dx.doi.org/10.5281/zenodo.18776)

* M. Yu and D. R. Trinkle, "Accurate and efficient algorithm for Bader charge integration." *J. Chem. Phys.* **134**, 064111 (2011). [doi](http://dx.doi.org//10.1063/1.3553716)
* M. Yu, D. R. Trinkle, and R. M. Martin, "Energy density in density functional theory: Application to crystalline defects and surfaces." *Phys. Rev. B* **83**, 115113 (2011). [doi](http://dx.doi.org/10.1103/PhysRevB.83.115113)
* M. Yu and D. R. Trinkle, "Au/TiO2(110) interfacial reconstruction stability from ab initio." *J. Phys. Chem. C* **115**, 17799-17805 (2011). [doi](http://dx.doi.org/10.1021/jp2017133)

# Contributors
Min Yu and Dallas R. Trinkle, algorithm development and implementation

# Acknowledgments
The research was supported by NSF under grant number DMR-1006077 and through the Materials Computation Center at UIUC, NSF DMR-0325939, and with computational resources from NSF/TeraGrid provided by NCSA and TACC. We also thank G. Henkelman at U. Texas for helpful discussions, and  R. E. L. Deville at UIUC for helpful discussions.
